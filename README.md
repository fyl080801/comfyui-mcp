# ComfyUI MCP Service

This project provides a dual-API server in front of a ComfyUI instance:

1. **RESTful API** - Standard HTTP API with proper REST conventions
2. **MCP Protocol** - Model Context Protocol for AI agent integration

The service allows you to expose specific ComfyUI workflows as clean, user-friendly APIs with async job-based execution.

## Features

- **Dual API Support**: Both RESTful API and MCP Protocol
- **RESTful Design**: Proper HTTP methods (GET, POST, DELETE) for resource-oriented operations
- **Async Job Execution**: Submit jobs and get immediate `job_id` for status polling
- **Real-time Progress Tracking**: Monitor workflow execution progress via WebSocket
- **Multiple Output Support**: Returns all images generated by a workflow
- **Complete Metadata**: Includes execution time, node history, and parameters
- **S3 Integration**: Optional upload of generated images to AWS S3
- **Interactive API Documentation**: Swagger UI for testing and exploring all endpoints

## Quick Start

```bash
# Install dependencies
npm install

# Configure your environment
cp .env.example .env
cp config.example.json config.json

# Start the server
npm run dev
```

The server will start on:

- **Port 8080**: MCP Protocol (for AI agents)
- **Port 3000**: RESTful API + Swagger UI

## RESTful API Endpoints

### Services

| Method | Endpoint                          | Description                        |
| ------ | --------------------------------- | ---------------------------------- |
| GET    | `/api/v1/services`                | List all available services        |
| GET    | `/api/v1/services/{service_name}` | Get service details                |
| POST   | `/api/v1/services/{service_name}` | Execute a workflow                 |

### Jobs

| Method | Endpoint                         | Description                        |
| ------ | -------------------------------- | ---------------------------------- |
| GET    | `/api/v1/jobs`                   | List jobs with filters             |
| GET    | `/api/v1/jobs/{job_id}`          | Get job status                     |
| GET    | `/api/v1/jobs/{job_id}/result`   | Get job result                     |
| DELETE | `/api/v1/jobs/{job_id}`          | Cancel a job                       |

### System

| Method | Endpoint         | Description                         |
| ------ | ---------------- | ----------------------------------- |
| GET    | `/api/v1/health` | Health check with statistics        |

## RESTful API Usage Examples

### 1. List Available Services

```bash
curl http://localhost:3000/api/v1/services
```

Response:
```json
{
  "total": 1,
  "services": [
    {
      "name": "text_to_image",
      "description": "Generate images from text prompts using ComfyUI",
      "parameters": [
        {
          "name": "prompt",
          "type": "string",
          "description": "The text prompt for image generation",
          "required": true
        }
      ]
    }
  ]
}
```

### 2. Execute a Service (Create Job)

```bash
curl -X POST http://localhost:3000/api/v1/services/text_to_image \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a stunning photograph of a majestic lion in the savannah",
    "negative_prompt": "blurry, cartoon, watermark",
    "seed": 12345
  }'
```

Response (201 Created):
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "service": "text_to_image",
  "message": "Job created successfully. Use GET /api/v1/jobs/{job_id} to check progress.",
  "created_at": "2025-12-24T10:30:00.000Z",
  "links": {
    "status": "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000",
    "result": "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000/result"
  }
}
```

### 3. Query Job Status

```bash
curl http://localhost:3000/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000
```

Response:
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "text_to",
  "status": "running",
  "created_at": "2025-12-24T10:30:00.000Z",
  "started_at": "2025-12-24T10:30:01.000Z",
  "progress": {
    "current": 5,
    "maximum": 8,
    "node": "4",
    "cached_nodes": ["1", "17", "18"],
    "timestamp": "2025-12-24T10:30:15.000Z"
  },
  "parameters": {
    "prompt": "a stunning photograph of a majestic lion in the savannah"
  },
  "links": {
    "self": "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000",
    "result": "/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000/result"
  }
}
```

### 4. List Jobs with Filters

```bash
# List all running jobs
curl "http://localhost:3000/api/v1/jobs?status=running"

# List jobs for a specific service
curl "http://localhost:3000/api/v1/jobs?service=text_to_image&limit=10"
```

### 5. Get Job Result

```bash
curl http://localhost:3000/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000/result
```

Response:
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "service": "text_to_image",
  "status": "completed",
  "execution_time": "44000ms",
  "total_images": 1,
  "prompt_id": "abc123",
  "node": "9",
  "display_node": "9",
  "node_history": [
    {
      "node": "3",
      "type": "KSampler",
      "executed_at": "2025-12-24T10:30:10.000Z"
    }
  ],
  "parameters": {
    "prompt": "a stunning photograph of a majestic lion in the savannah"
  },
  "images": [
    {
      "filename": "image_00001.png",
      "subfolder": "",
      "type": "output",
      "url": "http://127.0.0.1:8188/view?filename=image_00001.png&subfolder=&type=output",
      "s3_url": "https://your-bucket.s3.amazonaws.com/2025/12/24/image_00001.png"
    }
  ]
}
```

### 6. Cancel a Job

```bash
curl -X DELETE http://localhost:3000/api/v1/jobs/550e8400-e29b-41d4-a716-446655440000
```

Response:
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "cancelled",
  "message": "Job cancelled successfully"
}
```

### 7. Health Check

```bash
curl http://localhost:3000/api/v1/health
```

Response:
```json
{
  "status": "healthy",
  "timestamp": "2025-12-24T10:30:00.000Z",
  "services": {
    "comfyui": "available",
    "mcp": "available",
    "rest_api": "available"
  },
  "jobs": {
    "total": 42,
    "pending": 2,
    "running": 1,
    "completed": 38,
    "failed": 1
  }
}
```

## API Documentation

Interactive API documentation is available via Swagger UI:

- **Swagger UI**: <http://localhost:3000/api-docs>
- **OpenAPI JSON**: <http://localhost:3000/api-docs.json>
- **API Info**: <http://localhost:3000/>

The documentation includes:

- All registered workflow services
- Job management endpoints
- Interactive "Try it out" feature
- Request/response schemas
- Usage examples

## Prerequisites

- Node.js (v18 or later)
- A running instance of [ComfyUI](https://github.com/comfyanonymous/ComfyUI) with the `--listen` flag.
- AWS S3 bucket and credentials (optional, for S3 upload).

## Installation

1. Clone the repository:

   ```bash
   git clone <repository-url>
   cd comfyui-mcp
   ```

2. Install the dependencies:

   ```bash
   npm install
   ```

## Configuration

There are three main configuration files you need to set up.

### 1. `.env`

This file stores your AWS credentials. Create a `.env` file in the root of the project by copying the example file:

```bash
cp .env.example .env
```

Then, edit `.env` and fill in your AWS access key and secret key:

```text
AWS_ACCESS_KEY_ID=YOUR_AWS_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=YOUR_AWS_SECRET_KEY
S3_ENABLE=true
```

### 2. `config.json`

This file defines the core logic of the service. It maps your API endpoints to your ComfyUI workflows. Create it by copying the example:

```bash
cp config.example.json config.json
```

Then, edit `config.json`:

- **`comfyui.address`**: The address of your running ComfyUI instance (e.g., `http://127.0.0.1:8188`).
- **`s3.bucket`**: The name of your S3 bucket.
- **`s3.region`**: The AWS region of your S3 bucket (e.g., `us-east-1`).
- **`services`**: An array of API services you want to expose.
  - **`name`**: A unique name for your service (used in the API path).
  - **`description`**: Description of the service.
  - **`route`** (optional): Custom route for the service. If omitted, routes are auto-generated:
    - MCP services: `/mcp/{service_name}`
    - API services: `/api/v1/services/{service_name}`
  - **`comfyui_workflow_api`**: The filename of the JSON file containing the ComfyUI workflow API.
  - **`parameters`**: Defines how the request body maps to the ComfyUI workflow.
    - `name`: The key in the incoming JSON request body.
    - `type`: Parameter type (string, number, boolean, etc.)
    - `comfyui_node_id`: The ID of the node in your ComfyUI workflow to modify.
    - `comfyui_widget_name`: The specific input widget in that node (e.g., `text`, `seed`).

### 3. Workflow API JSON

For each service in `config.json`, you need a corresponding workflow API file (e.g., `workflow_api.json`).

To get this file:

1. In ComfyUI, create your desired workflow.
2. Click the "Save (API Format)" button. This will save a JSON file.
3. Place this file in the root of the project and reference its name in the `comfyui_workflow_api` field in `config.json`.

## Running the Service

Once configured, start the service with:

```bash
npm run dev
```

The server will start on:

- **Port 8080**: MCP Protocol server (for AI agents)
- **Port 3000**: RESTful API server + Swagger UI

You should see output like:

```text
JobManager initialized
ComfyUI tools registered successfully
ComfyUI MCP Server (MCP Protocol) started on port 8080
RESTful API server started on port 3000

RESTful API endpoints:
   → GET  /api/v1/services
   → GET  /api/v1/services/{service_name}
   → POST /api/v1/services/{service_name}
   → GET  /api/v1/jobs
   → GET  /api/v1/jobs/{job_id}
   → GET  /api/v1/jobs/{job_id}/result
   → DELETE /api/v1/jobs/{job_id}
   → GET  /api/v1/health

Documentation:
   → Swagger UI: http://localhost:3000/api-docs
   → OpenAPI JSON: http://localhost:3000/api-docs.json
   → API Info: http://localhost:3000/

MCP Protocol (AI Agents): http://localhost:8080/mcp
```

## Docker Deployment

```bash
# Build the image
docker build -t comfyui-mcp .

# Run with Docker
docker run -p 8080:8080 -p 3000:3000 \
  -v $(pwd)/config.json:/app/config.json:ro \
  comfyui-mcp

# Or use docker-compose
docker-compose up -d
```

Access:

- RESTful API: `http://localhost:3000/api/v1/*`
- Swagger UI: `http://localhost:3000/api-docs`
- MCP Protocol: `http://localhost:8080/mcp`

## Development Commands

```bash
# Development server
npm run dev

# Install dependencies
npm install

# Build for production
docker build -t comfyui-mcp .
```

## MCP Protocol (For AI Agents)

The server also supports the MCP (Model Context Protocol) on port 8080 for AI agent integration. See the [MCP documentation](https://modelcontextprotocol.io/) for details on how to integrate AI agents with this service.

## Environment Variables

| Variable               | Description                      | Default |
| ---------------------- | -------------------------------- | ------- |
| `EXPRESS_PORT`         | Port for RESTful API server      | `3000`  |
| `AWS_ACCESS_KEY_ID`    | AWS access key for S3            | -       |
| `AWS_SECRET_ACCESS_KEY`| AWS secret key for S3            | -       |
| `S3_ENABLE`            | Enable S3 upload                 | `false` |
| `S3_ENDPOINT`          | Custom S3 endpoint               | -       |
| `S3_PUBLIC_DOMAIN`     | Custom domain for S3 URLs        | -       |
