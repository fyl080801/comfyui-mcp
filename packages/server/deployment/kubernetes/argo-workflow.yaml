metadata:
  name: comfyui-mcp-build
  namespace: dev
  labels:
    workflows.argoproj.io/creator: ae2f33f4-c8e4-46e3-96a4-c999934586f6
    workflows.argoproj.io/creator-email: admin.at.fyl080801.uk
    workflows.argoproj.io/creator-preferred-username: admin
  annotations:
    description: ComfyUI-MCP æ„å»ºå·¥ä½œæµï¼ˆMonorepoï¼‰- å…‹éš†ä»£ç ã€é›†ç¾¤å†…æ„å»ºã€ä¸Šä¼  Harborã€‚é¡¹ç›®ä½¿ç”¨ pnpm workspace ç®¡ç†ï¼ŒåŒ…å« @comfyui-mcp/shared å’Œ @comfyui-mcp/server ä¸¤ä¸ªåŒ…ã€‚
  managedFields:
    - manager: argo
      operation: Update
      apiVersion: argoproj.io/v1alpha1
      time: '2025-12-25T13:41:44Z'
      fieldsType: FieldsV1
      fieldsV1:
        f:metadata:
          f:annotations:
            '.': {}
            f:description: {}
          f:labels:
            '.': {}
            f:workflows.argoproj.io/creator: {}
            f:workflows.argoproj.io/creator-email: {}
            f:workflows.argoproj.io/creator-preferred-username: {}
        f:spec: {}
spec:
  templates:
    - name: main
      inputs: {}
      outputs: {}
      metadata: {}
      steps:
        - - name: clone
            template: git-clone
            arguments:
              parameters:
                - name: gitRepo
                  value: '{{workflow.parameters.gitRepo}}'
                - name: gitRevision
                  value: '{{workflow.parameters.commit}}'
                - name: defaultRevision
                  value: '{{workflow.parameters.gitRevision}}'
        - - name: set-tags
            template: set-image-tags
            arguments:
              parameters:
                - name: version
                  value: '{{workflow.parameters.version}}'
                - name: commit
                  value: '{{steps.clone.outputs.parameters.commit}}'
        - - name: build-and-push
            template: buildah-build-push
            arguments:
              parameters:
                - name: imageName
                  value: '{{workflow.parameters.imageName}}'
                - name: imageTag
                  value: '{{steps.set-tags.outputs.parameters.imageTag}}'
                - name: imageTagLatest
                  value: '{{steps.set-tags.outputs.parameters.imageTagLatest}}'
                - name: harborAuthSecret
                  value: '{{workflow.parameters.harborAuthSecret}}'
              artifacts:
                - name: source
                  from: '{{steps.clone.outputs.artifacts.source}}'
        - - name: notify-success
            template: notify
            arguments:
              parameters:
                - name: status
                  value: success
                - name: message
                  value: "âœ… æ„å»ºæˆåŠŸ:
                    {{workflow.parameters.imageName}}:{{steps.set-tags.outputs.param\
                    eters.imageTag}}"
            when: '{{steps.build-and-push.status}} == Succeeded'
        - - name: notify-failure
            template: notify
            arguments:
              parameters:
                - name: status
                  value: failure
                - name: message
                  value: 'âŒ æ„å»ºå¤±è´¥: {{workflow.parameters.imageName}}'
            when: '{{steps.build-and-push.status}} != Succeeded'
    - name: git-clone
      inputs:
        parameters:
          - name: gitRepo
          - name: gitRevision
          - name: defaultRevision
      outputs:
        parameters:
          - name: commit
            valueFrom:
              path: /workspace/commit-sha.txt
        artifacts:
          - name: source
            path: /workspace
      metadata:
        annotations:
          description: å…‹éš† Git ä»“åº“å¹¶åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
      script:
        name: ''
        image: 192.168.68.95:31443/docker.io/alpine/git:latest
        command:
          - /bin/sh
          - -c
        envFrom:
          - configMapRef:
              name: '{{workflow.parameters.proxyConfigMap}}'
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 64Mi
        source: |
          set -e

          REPO="{{inputs.parameters.gitRepo}}"
          REVISION="{{inputs.parameters.gitRevision}}"
          DEFAULT_REVISION="{{inputs.parameters.defaultRevision}}"

          # å¦‚æœæ²¡æœ‰æŒ‡å®š commitï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯
          if [ -z "$REVISION" ] || [ "$REVISION" = "" ]; then
            REVISION="$DEFAULT_REVISION"
          fi

          echo "ğŸ” Cloning $REPO ..."
          git clone $REPO /workspace

          cd /workspace

          echo "ğŸ“Œ Fetching all branches and tags..."
          git fetch --tags --all

          echo "ğŸ“Œ Checking out $REVISION ..."
          git checkout $REVISION

          echo "âœ… Successfully checked out to $REVISION"
          echo ""
          echo "ğŸ“‹ Current commit:"
          git log -1 --oneline
          echo ""

          # è¾“å‡º commit SHA ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          COMMIT_SHA=$(git rev-parse HEAD)
          echo $COMMIT_SHA > /workspace/commit-sha.txt
          echo "ğŸ”– Commit SHA: $COMMIT_SHA"
    - name: set-image-tags
      inputs:
        parameters:
          - name: version
          - name: commit
      outputs:
        parameters:
          - name: imageTag
            valueFrom:
              path: /tmp/image-tag.txt
          - name: imageTagLatest
            valueFrom:
              path: /tmp/image-tag-latest.txt
      metadata: {}
      script:
        name: ''
        image: alpine:3.18
        command:
          - /bin/sh
          - -c
        resources: {}
        source: |
          VERSION="{{inputs.parameters.version}}"
          COMMIT="{{inputs.parameters.commit}}"

          echo "ğŸ·ï¸  Version: $VERSION"
          echo "ğŸ”– Commit: $COMMIT"

          if [ -z "$COMMIT" ] || [ "$COMMIT" = "" ]; then
            TAG="$VERSION"
            TAG_LATEST="$VERSION"
          else
            SHORT_COMMIT=${COMMIT:0:7}
            TAG="${VERSION}-${SHORT_COMMIT}"
            TAG_LATEST="$VERSION"
          fi

          echo "ğŸ“¦ Image Tag: $TAG"
          echo "ğŸ“¦ Latest Tag: $TAG_LATEST"

          # è¾“å‡ºåˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "$TAG" > /tmp/image-tag.txt
          echo "$TAG_LATEST" > /tmp/image-tag-latest.txt
    - name: buildah-build-push
      inputs:
        parameters:
          - name: imageName
          - name: imageTag
          - name: imageTagLatest
          - name: harborAuthSecret
        artifacts:
          - name: source
            path: /workspace
      outputs: {}
      metadata:
        annotations:
          description: ä½¿ç”¨ Buildah åœ¨é›†ç¾¤å†…æ„å»ºé•œåƒå¹¶æ¨é€åˆ° Harbor
      container:
        name: ''
        image: quay.io/buildah/stable:latest
        command:
          - /bin/sh
          - -c
        args:
          - |
            set -e

            IMAGE_NAME="{{inputs.parameters.imageName}}"
            IMAGE_TAG="{{inputs.parameters.imageTag}}"
            IMAGE_TAG_LATEST="{{inputs.parameters.imageTagLatest}}"

            echo "ğŸ”§ Verifying buildah installation..."
            buildah version
            echo ""

            echo "ğŸ“‚ Working directory: $(pwd)"
            echo "ğŸ“„ Dockerfile location: /workspace/Dockerfile"
            echo ""

            echo "ğŸš§ Building image: ${IMAGE_NAME}:${IMAGE_TAG}"
            buildah bud \
              --format docker \
              --file /workspace/Dockerfile \
              --tag ${IMAGE_NAME}:${IMAGE_TAG} \
              --tag ${IMAGE_NAME}:${IMAGE_TAG_LATEST} \
              /workspace

            echo "âœ… Build completed"
            echo ""

            echo "ğŸš€ Pushing images to Harbor..."
            echo "   - ${IMAGE_NAME}:${IMAGE_TAG}"
            buildah push \
              --tls-verify=false \
              --creds $USER:$PASS \
              ${IMAGE_NAME}:${IMAGE_TAG} \
              docker://${IMAGE_NAME}:${IMAGE_TAG}

            echo "   - ${IMAGE_NAME}:${IMAGE_TAG_LATEST}"
            buildah push \
              --tls-verify=false \
              --creds $USER:$PASS \
              ${IMAGE_NAME}:${IMAGE_TAG_LATEST} \
              docker://${IMAGE_NAME}:${IMAGE_TAG_LATEST}

            echo ""
            echo "âœ… Build & push completed successfully!"
            echo ""
            echo "ğŸ“¦ Images pushed:"
            echo "   - ${IMAGE_NAME}:${IMAGE_TAG}"
            echo "   - ${IMAGE_NAME}:${IMAGE_TAG_LATEST}"
        workingDir: /workspace
        envFrom:
          - configMapRef:
              name: '{{workflow.parameters.proxyConfigMap}}'
        env:
          - name: USER
            valueFrom:
              secretKeyRef:
                name: '{{inputs.parameters.harborAuthSecret}}'
                key: username
          - name: PASS
            valueFrom:
              secretKeyRef:
                name: '{{inputs.parameters.harborAuthSecret}}'
                key: password
        resources:
          limits:
            cpu: '2'
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 512Mi
        volumeMounts:
          - name: harbor-ca
            readOnly: true
            mountPath: /etc/pki/tls/certs/ca-trust-source/anchors/harbor.crt
            subPath: ca.crt
        securityContext:
          privileged: true
          runAsUser: 0
      volumes:
        - name: harbor-ca
          secret:
            secretName: '{{workflow.parameters.harborCaSecret}}'
            optional: true
    - name: notify
      inputs:
        parameters:
          - name: status
          - name: message
      outputs: {}
      metadata: {}
      script:
        name: ''
        image: alpine:3.18
        command:
          - /bin/sh
          - -c
        resources:
          limits:
            cpu: 100m
            memory: 64Mi
          requests:
            cpu: 50m
            memory: 32Mi
        source: |
          STATUS="{{inputs.parameters.status}}"
          MESSAGE="{{inputs.parameters.message}}"
          WORKFLOW="{{workflow.name}}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "======================================"
          echo "Workflow: $WORKFLOW"
          echo "Status: $STATUS"
          echo "Time: $TIMESTAMP"
          echo "Message: $MESSAGE"
          echo "======================================"
  entrypoint: main
  arguments:
    parameters:
      - name: generateName
        default: comfyui-mcp-build-
        description: Workflow å®ä¾‹çš„ generateName å‰ç¼€
      - name: gitRepo
        default: https://github.com/fyl080801/comfyui-mcp.git
        description: è¦å…‹éš†çš„ Git ä»“åº“åœ°å€
      - name: gitRevision
        default: master
        description: Git åˆ†æ”¯ã€tag æˆ– commit SHAï¼ˆé»˜è®¤ masterï¼‰
      - name: version
        default: 1.0.0
        description: é•œåƒç‰ˆæœ¬å·ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰
      - name: commit
        default: ''
        description: æŒ‡å®š commit SHAï¼ˆä¼˜å…ˆçº§é«˜äº gitRevisionï¼‰
      - name: imageName
        default: harbor-core.harbor.svc/ai-apps/comfyui-mcp
        description: æ„å»ºåé•œåƒçš„å®Œæ•´åç§°ï¼ˆå« registry/é¡¹ç›®ï¼‰
      - name: imageTag
        default: ''
        description: é•œåƒ tagï¼ˆé»˜è®¤ä¸º version-commit æ ¼å¼ï¼‰
      - name: harborAuthSecret
        default: harbor-auth
        description: Harbor è®¤è¯ä¿¡æ¯ secret åç§°
      - name: harborCaSecret
        default: harbor-ca-cert
        description: Harbor CA è¯ä¹¦ secret åç§°ï¼ˆè‡ªç­¾åè¯ä¹¦éœ€è¦ï¼‰
      - name: proxyConfigMap
        default: workflow-proxy-config
        description: ä»£ç†é…ç½® ConfigMap åç§°ï¼ˆå¯é€‰ï¼‰
