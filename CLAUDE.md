# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a TypeScript-based MCP (Model Context Protocol) server that exposes ComfyUI workflows as clean API endpoints with **async job-based execution**. It acts as an intermediary layer that:
1. Receives HTTP requests via FastMCP tools
2. Creates async jobs for workflow execution
3. Returns `job_id` immediately for status polling
4. Executes workflows via WebSocket connection to ComfyUI
5. Tracks progress and execution metadata
6. Optionally uploads generated images to AWS S3
7. Provides status query tools for job monitoring

The server runs on port 8080 using FastMCP's HTTP streaming transport.

## Key Features

- **Async Job Execution**: Tools return `job_id` immediately, execution runs in background
- **Status Polling**: Query job status, progress, and results via dedicated tools
- **Multiple Output Support**: Returns all images generated by a workflow
- **Complete Metadata**: Includes execution time, node history, and parameters
- **Progress Tracking**: Real-time progress updates during execution
- **In-Memory Job Storage**: Jobs stored in memory with configurable cleanup

## Development Commands

```bash
# Start development server
npm run dev

# Install dependencies
npm install

# Build for production
docker build -t comfyui-mcp .

# Run with Docker Compose
docker-compose up
```

Note: The project uses `tsx` for direct TypeScript execution (no build step required). Node.js v22 is managed via `mise.toml`.

## Architecture

### Request Flow (Async)

```
Client → FastMCP Tool → Create Job → Return job_id Immediately
                              ↓
                        Background Execution:
                        JobManager → ComfyUI WebSocket → Progress Events
                        → Process All Images → S3 Upload → Update Status

Client → Status Query Tools → Check Job Status/Results
```

### Key Components

**[src/index.ts](src/index.ts)** - Server entry point
- Initializes FastMCP server on port 8080
- Creates JobManager instance
- Registers ComfyUI tools with job tracking
- Optional periodic job cleanup

**[src/job/index.ts](src/job/index.ts)** - Job module exports
- Exports JobManager, JobStorage, and type definitions

**[src/job/manager.ts](src/job/manager.ts)** - Job lifecycle management
- Creates jobs with PENDING status
- Updates status: PENDING → RUNNING → COMPLETED/FAILED
- Tracks progress, errors, and results
- Provides job query and filtering methods

**[src/job/storage.ts](src/job/storage.ts)** - In-memory job storage
- Map-based storage for job metadata
- Filtering by service and status
- Automatic cleanup of old jobs

**[src/job/types.ts](src/job/types.ts)** - Type definitions
- JobStatus enum (pending, running, completed, failed, timeout, cancelled)
- JobMetadata, JobProgress, JobResult interfaces

**[src/comfyui/index.ts](src/comfyui/index.ts)** - Tool registration
- Dynamically creates FastMCP tools from `config.json` services
- **Service tools**: Return `job_id` immediately, execute in background
- **query_job_status**: Query job status by ID
- **list_jobs**: List jobs with optional filters
- **get_job_result**: Get completed job results with all images
- **comfyui_health_check**: Health check with job statistics

**[src/comfyui/ws-enhanced.ts](src/comfyui/ws-enhanced.ts)** - Enhanced WebSocket client
- Extends base ComfyuiWebsocket with job tracking
- Captures all ComfyUI events: progress, execution_cached, executing
- Tracks node execution history
- Updates job progress in real-time

**[src/comfyui/ws.ts](src/comfyui/ws.ts)** - Base WebSocket client
- Manages WebSocket connection to ComfyUI
- Implements timeout handling (default 10 minutes)
- Dispatches events: `executing`, `executed`, `error`

**[src/config/index.ts](src/config/index.ts)** - Configuration loader
- Loads `config.json` for service definitions
- Supports optional `jobs` configuration
- Environment variable overrides

**[src/comfyui/s3.ts](src/comfyui/s3.ts)** - S3 upload handler
- Uploads images with date-based folder structure (YYYY/MM/DD)

### Configuration Structure

**[config.json](config.json)** - Service definitions:
```json
{
  "comfyui": {
    "address": "http://127.0.0.1:8188",
    "client_id": "comfyui-mcp-client"
  },
  "s3": {
    "bucket": "your-bucket",
    "region": "us-east-1"
  },
  "jobs": {
    "max_job_age": 86400000,
    "max_jobs": 1000,
    "cleanup_interval": 3600000
  },
  "services": [
    {
      "name": "text_to_image",
      "comfyui_workflow_api": "workflow_api.json",
      "parameters": [
        {
          "name": "prompt",
          "comfyui_node_id": "6",
          "comfyui_widget_name": "text",
          "type": "string",
          "required": true
        }
      ]
    }
  ]
}
```

**Environment Variables** ([.env](.env)):
- `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY` - S3 credentials
- `S3_ENABLE=true` - Enable S3 upload (otherwise returns ComfyUI URL directly)
- `S3_ENDPOINT` - Optional S3-compatible endpoint
- `S3_PUBLIC_DOMAIN` - Custom domain for S3 URLs

### Tool Response Formats

#### Service Tool Response (e.g., text_to_image)
```json
{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "pending",
  "message": "Job created successfully. Use query_job_status to check progress."
}
```

#### query_job_status Response
```json
{
  "job_id": "...",
  "service": "text_to_image",
  "status": "running",
  "created_at": "2025-12-23T10:30:00.000Z",
  "started_at": "2025-12-23T10:30:01.000Z",
  "progress": {
    "current": 5,
    "maximum": 8,
    "node": "4",
    "cachedNodes": ["1", "17", "18"],
    "timestamp": "2025-12-23T10:30:15.000Z"
  },
  "parameters": { "prompt": "a beautiful sunset" }
}
```

#### get_job_result Response
Returns metadata + all image resources:
```json
{
  "job_id": "...",
  "service": "text_to_image",
  "status": "completed",
  "execution_time": "44000ms",
  "total_images": 1,
  "prompt_id": "abc123",
  "node_history": [...],
  "parameters": { "prompt": "a beautiful sunset" }
}
```
Plus resource items for each image with `uri` field.

## Docker Deployment

### Dockerfile
Multi-stage build using Node.js 22 Alpine:
- **Stage 1**: Install dependencies and copy source
- **Stage 2**: Production runtime with non-root user
- Health check on `/mcp` endpoint
- Exposes port 8080

### docker-compose.yml
- ComfyUI-MCP service with configurable environment
- Optional ComfyUI service (commented out)
- Shared network for service communication

### Build and Run
```bash
# Build image
docker build -t comfyui-mcp .

# Run standalone
docker run -p 8080:8080 \
  -e COMFYUI_ADDRESS=http://comfyui:8188 \
  -v $(pwd)/config.json:/app/config.json:ro \
  comfyui-mcp

# Run with compose
docker-compose up -d
```

## Important Implementation Details

### Job Lifecycle
1. **PENDING**: Job created, waiting to start
2. **RUNNING**: WebSocket connected, execution in progress
3. **COMPLETED**: Execution finished successfully
4. **FAILED**: Execution failed with error
5. **TIMEOUT**: Execution exceeded timeout
6. **CANCELLED**: Job was cancelled

### Parameter Mapping
Parameters in `config.json` map request body fields to ComfyUI workflow nodes:
- `name` - Key in incoming request JSON
- `comfyui_node_id` - String key in workflow JSON (e.g., "6")
- `comfyui_widget_name` - Property within `node.inputs` (e.g., "text", "seed")

### WebSocket Event Handling
The enhanced WebSocket client captures all ComfyUI events:
- `progress`: Updates job progress with current/maximum values
- `execution_cached`: Tracks nodes that were cached
- `executing`: Notes when a node starts execution
- `executed`: Marks job as completed with results
- `error`: Marks job as failed with error details

### Multiple Output Support
- Processes ALL images from `result.output.images[]`
- Each image gets ComfyUI URL and optional S3 URL
- `get_job_result` returns all images as separate resources

### S3 Upload Control
- `S3_ENABLE=true`: Downloads image from ComfyUI, uploads to S3, returns S3 URL
- `S3_ENABLE` unset/false: Returns ComfyUI's direct URL

### Error Handling
All tool errors are caught and re-thrown with descriptive messages including the service name. Background execution errors are stored in job metadata.

### Job Cleanup
Old jobs are automatically cleaned up based on configuration:
- `max_job_age`: Maximum age before cleanup (default 24 hours)
- `cleanup_interval`: How often to run cleanup (default 1 hour)
